# Выбор и настройка мониторинга в системе

## Мотивация
Отсутствие системы мониторинга препятствует объективной оценке работоспособности и эффективности информационных систем. 
Невозможно оперативно и точно определить:
- **Метрики производительности системы:** Утилизация вычислительных ресурсов (CPU, память, дисковое пространство), сетевой трафик.
- **Бизнес-показатели:** Количество активных пользователей, объем транзакций, среднее время обработки операций.
- **Показатели отказоустойчивости:** Частота возникновения ошибок, время восстановления после сбоев, количество повторных попыток выполнения операций.

Эффективное управление и развитие ИТ-инфраструктуры без мониторинга не представляется возможным. Без мониторинга затрудняется:
- **Выявление и устранение “узких мест”** в производительности системы.
- **Прогнозирование потребности в дополнительных ресурсах** и планирование масштабирования инфраструктуры.
- **Оперативное реагирование на инциденты** и минимизация негативного влияния на бизнес-процессы.

Внедрение системы мониторинга является критически важным шагом для обеспечения стабильности, эффективности и масштабируемости ИТ-инфраструктуры.

## Выбор подхода к мониторингу
Для обеспечения всестороннего контроля над различными компонентами системы предлагается использовать два подхода к 
мониторингу, адаптированных к их специфике:

- **USE Method (Utilization, Saturation, Errors):** 
Рекомендован для мониторинга MES (Manufacturing Execution System) сервиса, характеризующегося интенсивными 
вычислительными процессами. Данный подход позволяет эффективно выявлять проблемы, связанные с неоптимальным 
использованием ресурсов CPU, памяти и дискового пространства.
- **RED Method (Rate, Errors, Duration):** 
Предлагается использовать для мониторинга остальных сервисов (CRM API, Shop API и др.), поскольку он является 
универсальным и подходит для мониторинга веб-сервисов, запросов к базам данных, очередей сообщений и других компонентов. 
Данный подход позволяет отслеживать ключевые показатели: количество запросов, количество ошибок и время обработки 
запросов.

## Метрики для отслеживания
Список необходимых метрик для отслеживания работы приложений.
Отображения очереди. Если растёт этот показатель, значит много сообщений зависло и очередь не справляется.
- Number of dead-letter-exchange letters in RabbitMQ  
Ярлыки:  
- queue_name - наименование очереди.
- reason - причина.

Отображения загруженности сервиса
- Number of requests (RPS) for internet shop API
- Number of requests (RPS) for CRM API
- Number of requests (RPS) for MES API  
Ярлыки:  
- endpoint - URL идёт запроса.
- method - HTTP-метод (GET, POST и т.д.).

Процент загруженности ЦП для оценки стабильности работы сервиса и принятия решения о масштабировании
- CPU % for shop API
- CPU % for CRM API
- CPU % for MES API  
Ярлыки:  
- instance_id - если сервис запущен в нескольких инстансах.

Загруженность оперативной памяти для оценки стабильности работы сервиса и принятия решения о масштабировании
- Memory Utilisation for shop API
- Memory Utilisation for CRM API
- Memory Utilisation for MES API
- Memory Utilisation for shop db instance
- Memory Utilisation for MES db instance
- Number of connections for shop db instance
- Number of connections for MES db instance  
Ярлыки:  
- instance_id или db_instance - чтобы различать инстансы и базы.

Оценка производительности сервиса и стабильности его работы.
- Response time (latency) for shop API
- Response time (latency) for CRM API
- Response time (latency) for MES API  
Ярлыки:  
- endpoint - URL запроса.
- method - тип запроса (GET, POST и т.д.).
- status_code - статус различных запросов.

Отображение ошибок. Если растёт количество 500-х ответов, значит есть рост критических ошибок, и пользователи не
могут оформить заказ или запросить расчёт. Надо реагировать сразу, чтобы не терять прибыль.
- Number of HTTP 500 for shop API
- Number of HTTP 500 for CRM API
- Number of HTTP 500 for MES API  
Ярлыки:  
- endpoint - URL запроса.

Дополнительные бизнес-метрики:
- Процент заказов, которые зависли в определённом статусе.
- Число новых заказов за сутки.
- Среднее время прохождения заказа от оформления до готовности.  
Ярлыки:  
- status - например, INITIATED, FILE_UPLOADED, SUBMITTED и т.д.
- channel - B2B или B2C.

## План действий
1. Развертывание инфраструктуры мониторинга. Установка и настройка Prometheus, Grafana, экспортёры (Node/RabbitMQ/Postgres/Micrometer).
2. Настроить сбор базовых метрик (RPS, CPU, Memory, Dead-letter и др.).
3. Настроить метрики бизнес-логики (застрявшие заказы, время расчёта и т.д.) в CRM/MES.
4. Разработка информационных панелей (дашбордов) в Grafana (RabbitMQ, MES, Shop API, CRM API).
5. Настройка системы оповещений (алертинга). Настройка автоматических уведомлений (по электронной почте, в мессенджеры) 
при превышении установленных порогов.
6. Развертывание независимых инстансов Prometheus, Grafana и экспортёров для различных сред разработки и эксплуатации: 
dev (разработка), release (тестирование), production (боевая среда).